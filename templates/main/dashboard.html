{% extends 'main/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="mb-10">
  <h1 class="text-3xl font-extrabold tracking-tight mb-2">Portfolio Overview</h1>
  <p class="text-gray-500">Real-time valuation and performance metrics.</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
  <div class="glass p-6 rounded-3xl card-shadow">
    <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Available Cash</p>
    <h2 class="text-2xl font-black">₹{{ profile.balance|floatformat:2 }}</h2>
  </div>
  <div class="glass p-6 rounded-3xl card-shadow">
    <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Total Invested</p>
    <h2 class="text-2xl font-black">₹{{ total_invested|floatformat:2 }}</h2>
  </div>
  <div class="glass p-6 rounded-3xl card-shadow">
    <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Current Value</p>
    <h2 class="text-2xl font-black">₹{{ current_value|floatformat:2 }}</h2>
  </div>
  <div
    class="glass p-6 rounded-3xl card-shadow border-t-4 {% if profit_loss >= 0 %}border-groww{% else %}border-red-500{% endif %}">
    <p class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Returns (P&L)</p>
    <h2 class="text-2xl font-black {% if profit_loss >= 0 %}text-groww{% else %}text-red-500{% endif %}">
      ₹{{ profit_loss|floatformat:2 }}
      <span class="text-xs font-medium ml-1">({{ pnl_percent|floatformat:2 }}%)</span>
    </h2>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
  <!-- Chart Section -->
  <div class="lg:col-span-2 glass p-8 rounded-[40px] card-shadow">
    <div class="flex justify-between items-center mb-8">
      <h3 class="text-xl font-bold">Growth Analysis</h3>
      <div class="flex space-x-2">
        <span class="bg-groww/10 text-groww text-xs px-3 py-1 rounded-full font-bold">LIVE</span>
      </div>
    </div>
    <div class="h-80">
      <canvas id="growthChart"></canvas>
    </div>
  </div>

  <!-- Quick Trade / Top Stocks -->
  <div class="glass p-8 rounded-[40px] card-shadow">
    <h3 class="text-xl font-bold mb-8">Market Pulse</h3>
    <div class="space-y-6">
      {% for stock in top_stocks %}
      <div class="flex justify-between items-center group">
        <div class="flex items-center space-x-4">
          <div
            class="w-10 h-10 bg-white/5 rounded-2xl flex items-center justify-center font-bold text-groww border border-white/10">
            {{ stock.symbol|slice:":1" }}
          </div>
          <div>
            <p class="font-extrabold text-sm">{{ stock.symbol }}</p>
            <p class="text-[10px] text-gray-500 uppercase tracking-wider">{{ stock.name|slice:":15" }}...</p>
          </div>
        </div>
        <div class="text-right">
          <p class="font-bold text-sm">₹{{ stock.price }}</p>
          <p class="text-[10px] {% if stock.change >= 0 %}text-groww{% else %}text-red-500{% endif %} font-bold">
            {% if stock.change >= 0 %}+{% endif %}{{ stock.change_percent }}%
          </p>
        </div>
        <div class="ml-4 opacity-0 group-hover:opacity-100 transition">
          <a href="{% url 'buy_stock' stock.id %}" class="bg-groww text-black p-2 rounded-xl text-xs font-bold">
            <i class="fas fa-plus"></i>
          </a>
        </div>
      </div>
      {% endfor %}

      <div class="pt-6 border-t border-white/5 grid grid-cols-2 gap-4">
        <a href="{% url 'sip' %}"
          class="bg-groww/10 text-groww py-3 rounded-2xl text-[10px] font-black text-center border border-groww/20 hover:bg-groww hover:text-black transition uppercase">Mutual
          Funds</a>
        <a href="{% url 'fo' %}"
          class="bg-red-500/10 text-red-500 py-3 rounded-2xl text-[10px] font-black text-center border border-red-500/20 hover:bg-red-500 hover:text-white transition uppercase">F&O
          Trading</a>
      </div>

      <div class="pt-4">
        <form action="{% url 'buy_stock_search' %}" method="get" class="relative">
          <input type="text" name="symbol" placeholder="Search Symbol (e.g. AAPL)"
            class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-sm focus:outline-none focus:border-groww transition">
          <button type="submit" class="absolute right-4 top-3 text-gray-500 hover:text-groww">
            <i class="fas fa-search"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

{{ chart_labels|json_script:"chart-labels-data" }}
{{ chart_data|json_script:"chart-data" }}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const labelsData = JSON.parse(document.getElementById('chart-labels-data').textContent);
    const chartDataValue = JSON.parse(document.getElementById('chart-data').textContent);

    const ctx = document.getElementById('growthChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(0, 208, 156, 0.3)');
    gradient.addColorStop(1, 'rgba(0, 208, 156, 0)');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labelsData,
        datasets: [{
          label: 'Portfolio Value',
          data: chartDataValue,
          borderColor: '#00d09c',
          borderWidth: 4,
          tension: 0.4,
          pointRadius: 0,
          fill: true,
          backgroundColor: gradient
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1f2937',
            titleColor: '#9ca3af',
            bodyColor: '#fff',
            padding: 12,
            displayColors: false
          }
        },
        scales: {
          y: { display: false },
          x: {
            grid: { display: false },
            ticks: { color: '#4b5563', font: { size: 10, weight: 'bold' } }
          }
        }
      }
    });
  });
</script>
{% endblock %}